# ğŸ“Š SCHÃ‰MA SYSTÃˆME RÃ‰SERVATION v2.7

## ğŸ”„ WORKFLOW COMPLET

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Ã‰TAT INITIAL                                  â”‚
â”‚                                                                  â”‚
â”‚  Articles Table:                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚ Nom          â”‚ Prix  â”‚ Stock        â”‚                       â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚
â”‚  â”‚ Sandwich     â”‚ 5â‚¬    â”‚  20          â”‚                       â”‚
â”‚  â”‚ Boisson      â”‚ 2â‚¬    â”‚  30          â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                                                  â”‚
â”‚  Reservation Table:  [VIDE]                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Ã‰TAPE 1 : CLIENT CRÃ‰E COMMANDE                     â”‚
â”‚                                                                  â”‚
â”‚  Page Client:                                                    â”‚
â”‚  - Client "Jean" commande 3 Sandwichs                           â”‚
â”‚  - Commande crÃ©Ã©e en base (statut: en_attente)                  â”‚
â”‚                                                                  â”‚
â”‚  Stock affichÃ©: 20 (rien de rÃ©servÃ© encore)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Ã‰TAPE 2 : CAISSIÃˆRE CLIQUE "ENCAISSER"                 â”‚
â”‚                                                                  â”‚
â”‚  Page Caisse:                                                    â”‚
â”‚  1. ouvrirPaiement('Jean')                                       â”‚
â”‚  2. POST /api/reservations/commande/Jean                        â”‚
â”‚     Body: { items: [{article_id:1, quantite:3}] }              â”‚
â”‚                                                                  â”‚
â”‚  Backend:                                                        â”‚
â”‚  - VÃ©rifie stock rÃ©el (20 - 0 = 20) âœ“                          â”‚
â”‚  - CrÃ©e rÃ©servation                                             â”‚
â”‚                                                                  â”‚
â”‚  Reservation Table:                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚ Commande     â”‚ Article    â”‚ QuantitÃ© â”‚                      â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                      â”‚
â”‚  â”‚ Jean         â”‚ Sandwich   â”‚    3     â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                                                  â”‚
â”‚  Stock affichÃ©: 20 - 3 = 17  â† STOCK RÃ‰EL                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                   â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  SCÃ‰NARIO A:     â”‚   â”‚  SCÃ‰NARIO B:   â”‚
          â”‚  CONFIRMER       â”‚   â”‚  ANNULER       â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                   â”‚
                    â†“                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SCÃ‰NARIO A : CONFIRMER     â”‚ â”‚  SCÃ‰NARIO B : ANNULER        â”‚
â”‚                             â”‚ â”‚                              â”‚
â”‚  Page Caisse:               â”‚ â”‚  Page Caisse:                â”‚
â”‚  - confirmerPaiement()      â”‚ â”‚  - fermerModal()             â”‚
â”‚  - PUT /api/commandes/X/    â”‚ â”‚  - DELETE /api/reservations/ â”‚
â”‚    payer                    â”‚ â”‚    commande/Jean             â”‚
â”‚                             â”‚ â”‚                              â”‚
â”‚  Backend:                   â”‚ â”‚  Backend:                    â”‚
â”‚  1. Paiement validÃ©         â”‚ â”‚  1. Supprime rÃ©servation     â”‚
â”‚  2. Supprime rÃ©servation    â”‚ â”‚  2. Stock NON modifiÃ©        â”‚
â”‚  3. Trigger dÃ©crÃ©mente      â”‚ â”‚                              â”‚
â”‚     stock                   â”‚ â”‚  Reservation Table:          â”‚
â”‚                             â”‚ â”‚  [VIDE] â† SupprimÃ©e          â”‚
â”‚  Reservation Table:         â”‚ â”‚                              â”‚
â”‚  [VIDE] â† SupprimÃ©e         â”‚ â”‚  Articles Table:             â”‚
â”‚                             â”‚ â”‚  Stock Sandwich: 20          â”‚
â”‚  Articles Table:            â”‚ â”‚  â†‘ Pas changÃ©!               â”‚
â”‚  Stock Sandwich: 17         â”‚ â”‚                              â”‚
â”‚  â†‘ DÃ©crÃ©mentÃ©!              â”‚ â”‚  âœ… Articles libÃ©rÃ©s         â”‚
â”‚                             â”‚ â”‚                              â”‚
â”‚  âœ… Paiement confirmÃ©       â”‚ â”‚                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—ï¸ ARCHITECTURE TECHNIQUE

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         FRONTEND                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Page Client (index.html)                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚  Articles affichÃ©s avec:                        â”‚            â”‚
â”‚  â”‚  Stock = stock_reel_disponible                  â”‚            â”‚
â”‚  â”‚  (stock initial - rÃ©servations)                 â”‚            â”‚
â”‚  â”‚                                                  â”‚            â”‚
â”‚  â”‚  Bouton "-" : Toujours actif                    â”‚            â”‚
â”‚  â”‚  Bouton "+" : BloquÃ© au stock rÃ©el              â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                         â†• GET /api/articles                      â”‚
â”‚                                                                  â”‚
â”‚  Page Caisse (caisse.html)                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚  Clic "Encaisser"                               â”‚            â”‚
â”‚  â”‚    â†’ ouvrirPaiement(nom)                        â”‚            â”‚
â”‚  â”‚    â†’ POST /api/reservations/commande/:nom       â”‚            â”‚
â”‚  â”‚                                                  â”‚            â”‚
â”‚  â”‚  Clic "Confirmer"                               â”‚            â”‚
â”‚  â”‚    â†’ confirmerPaiement()                        â”‚            â”‚
â”‚  â”‚    â†’ PUT /api/commandes/:id/payer               â”‚            â”‚
â”‚  â”‚                                                  â”‚            â”‚
â”‚  â”‚  Clic "Annuler"                                 â”‚            â”‚
â”‚  â”‚    â†’ fermerModal()                              â”‚            â”‚
â”‚  â”‚    â†’ DELETE /api/reservations/commande/:nom     â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†• HTTP API
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         BACKEND (server.js)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Endpoints RÃ©servations:                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ POST /api/reservations/commande/:nom           â”‚            â”‚
â”‚  â”‚  - VÃ©rifie stock rÃ©el disponible               â”‚            â”‚
â”‚  â”‚  - CrÃ©e rÃ©servations temporaires                â”‚            â”‚
â”‚  â”‚  - Retourne erreur si stock insuffisant         â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ DELETE /api/reservations/commande/:nom         â”‚            â”‚
â”‚  â”‚  - Supprime toutes rÃ©servations de la commande â”‚            â”‚
â”‚  â”‚  - LibÃ¨re le stock                              â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                  â”‚
â”‚  Endpoints ModifiÃ©s:                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ PUT /api/commandes/:id/payer                   â”‚            â”‚
â”‚  â”‚  - Traite paiement                              â”‚            â”‚
â”‚  â”‚  - Supprime rÃ©servations                        â”‚            â”‚
â”‚  â”‚  - DÃ©crÃ©mente stock (via trigger)               â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ GET /api/articles                               â”‚            â”‚
â”‚  â”‚  - Nettoie rÃ©servations expirÃ©es                â”‚            â”‚
â”‚  â”‚  - Retourne articles avec stock_reel_disponible â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†• SQL
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DATABASE (PostgreSQL)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Table: reservation_temporaire                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ id           â”‚ nom_comm.  â”‚ article  â”‚ quantitÃ©   â”‚         â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”‚
â”‚  â”‚ 1            â”‚ Jean       â”‚ 1        â”‚ 3          â”‚         â”‚
â”‚  â”‚ 2            â”‚ Marie      â”‚ 2        â”‚ 5          â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                  â”‚
â”‚  Vue: v_stock_disponible                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ SELECT                                          â”‚            â”‚
â”‚  â”‚   a.stock_disponible as stock_initial,         â”‚            â”‚
â”‚  â”‚   SUM(rt.quantite) as quantite_reservee,       â”‚            â”‚
â”‚  â”‚   stock_initial - quantite_reservee            â”‚            â”‚
â”‚  â”‚     as stock_reel_disponible                   â”‚            â”‚
â”‚  â”‚ FROM articles a                                 â”‚            â”‚
â”‚  â”‚ LEFT JOIN reservation_temporaire rt             â”‚            â”‚
â”‚  â”‚   ON a.id = rt.article_id                      â”‚            â”‚
â”‚  â”‚ GROUP BY a.id                                   â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                  â”‚
â”‚  Fonctions:                                                      â”‚
â”‚  - nettoyer_reservations_expirees()                             â”‚
â”‚    â†’ Supprime rÃ©servations > 30 minutes                         â”‚
â”‚                                                                  â”‚
â”‚  - supprimer_reservations(nom_commande)                         â”‚
â”‚    â†’ Supprime toutes rÃ©servations d'une commande                â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ˆ EXEMPLE CONCRET

### Situation Initiale
```
Article: Sandwich
Stock en base: 20
RÃ©servations: 0
Stock affichÃ©: 20
```

### Timeline
```
10:00 - CaissiÃ¨re A : "Encaisser" commande Jean (3 sandwichs)
        â”œâ”€ RÃ©servation crÃ©Ã©e: Jean â†’ 3 sandwichs
        â””â”€ Stock affichÃ©: 17

10:02 - CaissiÃ¨re B : Consulte articles
        â””â”€ Voit stock: 17 (20 - 3 rÃ©servÃ©s)

10:03 - CaissiÃ¨re B : "Encaisser" commande Marie (5 sandwichs)
        â”œâ”€ RÃ©servation crÃ©Ã©e: Marie â†’ 5 sandwichs
        â””â”€ Stock affichÃ©: 12 (20 - 3 - 5)

10:05 - Client Paul : Consulte page client
        â””â”€ Voit stock: 12 sandwichs

10:06 - CaissiÃ¨re A : "Confirmer" paiement Jean
        â”œâ”€ RÃ©servation Jean supprimÃ©e
        â”œâ”€ Stock dÃ©crÃ©mentÃ©: 20 â†’ 17
        â””â”€ Stock affichÃ©: 12 (17 - 5 rÃ©servÃ©s par Marie)

10:08 - CaissiÃ¨re B : "Annuler" commande Marie
        â”œâ”€ RÃ©servation Marie supprimÃ©e
        â”œâ”€ Stock PAS dÃ©crÃ©mentÃ©
        â””â”€ Stock affichÃ©: 17 (libÃ©rÃ©)

RÃ©sultat final:
Stock en base: 17 (20 - 3 payÃ©s)
RÃ©servations: 0
Stock affichÃ©: 17 âœ…
```

---

## ğŸ¯ CALCULS STOCK

### Formule Principale
```
Stock AffichÃ© = Stock Initial - RÃ©servations Actives

OÃ¹:
  Stock Initial = stock_disponible (table articles)
  RÃ©servations  = SUM(quantite) FROM reservation_temporaire
```

### Exemple Calcul
```sql
SELECT 
    a.nom,
    a.stock_disponible as initial,
    COALESCE(SUM(rt.quantite), 0) as reserve,
    a.stock_disponible - COALESCE(SUM(rt.quantite), 0) as affiche
FROM articles a
LEFT JOIN reservation_temporaire rt ON a.id = rt.article_id
WHERE a.nom = 'Sandwich'
GROUP BY a.id;

RÃ©sultat:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ nom      â”‚ initial â”‚ reserve â”‚ affiche â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Sandwich â”‚   20    â”‚    8    â”‚   12    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## â±ï¸ GESTION TEMPS

### DurÃ©e Vie RÃ©servation
```
CrÃ©ation â†’ created_at = NOW()
         â†“
    Expiration aprÃ¨s 30 minutes
         â†“
    Cleanup automatique
```

### Points de Cleanup
1. **Automatique :** Ã€ chaque appel GET /api/articles
2. **Manuel :** Via SQL `SELECT nettoyer_reservations_expirees()`
3. **Event :** Peut Ãªtre configurÃ© en cron job

### Exemple Timeline
```
10:00:00 - RÃ©servation crÃ©Ã©e (Jean)
10:30:00 - RÃ©servation expire
10:30:15 - GET /api/articles appelÃ©
10:30:15 - Cleanup dÃ©clenchÃ©
10:30:16 - RÃ©servation Jean supprimÃ©e automatiquement
```

---

## ğŸ” SÃ‰CURITÃ‰

### PrÃ©vention Race Conditions
```
Transaction SQL:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BEGIN;                      â”‚
â”‚   1. VÃ©rifier stock         â”‚
â”‚   2. CrÃ©er rÃ©servation      â”‚
â”‚   3. COMMIT;                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Si 2 requÃªtes simultanÃ©es:
  â†’ PostgreSQL gÃ¨re la concurrence
  â†’ SÃ©rialise les transactions
  â†’ Une seule peut rÃ©server en premier
```

### Contrainte UnicitÃ©
```sql
UNIQUE(nom_commande, article_id)

EmpÃªche:
- 2 rÃ©servations pour mÃªme commande/article
- Doublons accidentels
```

---

**SystÃ¨me robuste et production-ready ! ğŸ‰**
